name: 'Rustã‚³ãƒ¼ãƒ‰ã®lint'
description: 'Clippyã¨Rustfmtã«ã‚ˆã‚‹Rustã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯'

inputs:
  toolchain:
    description: 'Rustã®ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³'
    required: false
    default: 'stable'
  components:
    description: 'ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ'
    required: false
    default: 'rustfmt, clippy'
  clippy-options:
    description: 'Clippyã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³'
    required: false
    default: '--all-features --all-targets -- -D warnings'
  check-documentation:
    description: 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã‹ã©ã†ã‹'
    required: false
    default: 'true'
  cache-key:
    description: 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚­ãƒ¼'
    required: false
    default: 'lint-rust'

runs:
  using: "composite"
  steps:
    - name: å®Ÿè¡Œæƒ…å ±ã®åˆæœŸåŒ–
      shell: bash
      run: |
        echo "ACTION_SUMMARY=[]" >> $GITHUB_ENV
        echo "LINT_RESULTS=[]" >> $GITHUB_ENV

    - name: Setup Rustç’°å¢ƒ
      uses: ./.github/actions/setup-rust
      with:
        toolchain: ${{ inputs.toolchain }}
        components: ${{ inputs.components }}
        cache-key: ${{ inputs.cache-key }}
        install-dependencies: 'true'
        
    - name: Check format
      shell: bash
      run: |
        set +e
        cargo fmt --all -- --check
        FMT_EXIT_CODE=$?
        set -e
        
        if [ $FMT_EXIT_CODE -eq 0 ]; then
          echo "LINT_RESULTS=$(echo $LINT_RESULTS | jq -c '. += ["âœ… Rustfmtãƒã‚§ãƒƒã‚¯ã«æˆåŠŸã—ã¾ã—ãŸ"]')" >> $GITHUB_ENV
        else
          echo "LINT_RESULTS=$(echo $LINT_RESULTS | jq -c '. += ["âŒ Rustfmtãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ"]')" >> $GITHUB_ENV
        fi
        
        echo "ACTION_SUMMARY=$(echo $ACTION_SUMMARY | jq -c '. += ["Rustfmtã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ"]')" >> $GITHUB_ENV
        
        # å…ƒã®ã‚³ãƒžãƒ³ãƒ‰ã®exitã‚³ãƒ¼ãƒ‰ã‚’è¿”ã™
        exit $FMT_EXIT_CODE
        
    - name: Clippy
      shell: bash
      run: |
        set +e
        cargo clippy ${{ inputs.clippy-options }} 
        CLIPPY_EXIT_CODE=$?
        set -e
        
        if [ $CLIPPY_EXIT_CODE -eq 0 ]; then
          echo "LINT_RESULTS=$(echo $LINT_RESULTS | jq -c '. += ["âœ… Clippyãƒã‚§ãƒƒã‚¯ã«æˆåŠŸã—ã¾ã—ãŸ"]')" >> $GITHUB_ENV
        else
          echo "LINT_RESULTS=$(echo $LINT_RESULTS | jq -c '. += ["âŒ Clippyãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ"]')" >> $GITHUB_ENV
        fi
        
        echo "ACTION_SUMMARY=$(echo $ACTION_SUMMARY | jq -c '. += ["Clippyã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³: ${{ inputs.clippy-options }})"]')" >> $GITHUB_ENV
        
        # å…ƒã®ã‚³ãƒžãƒ³ãƒ‰ã®exitã‚³ãƒ¼ãƒ‰ã‚’è¿”ã™
        exit $CLIPPY_EXIT_CODE
      
    - name: Check documentation
      if: inputs.check-documentation == 'true'
      shell: bash
      run: |
        set +e
        RUSTDOCFLAGS='-D warnings' cargo doc --no-deps
        DOC_EXIT_CODE=$?
        set -e
        
        if [ $DOC_EXIT_CODE -eq 0 ]; then
          echo "LINT_RESULTS=$(echo $LINT_RESULTS | jq -c '. += ["âœ… ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ã«æˆåŠŸã—ã¾ã—ãŸ"]')" >> $GITHUB_ENV
        else
          echo "LINT_RESULTS=$(echo $LINT_RESULTS | jq -c '. += ["âŒ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ"]')" >> $GITHUB_ENV
        fi
        
        echo "ACTION_SUMMARY=$(echo $ACTION_SUMMARY | jq -c '. += ["Rustãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ"]')" >> $GITHUB_ENV
        
        # å…ƒã®ã‚³ãƒžãƒ³ãƒ‰ã®exitã‚³ãƒ¼ãƒ‰ã‚’è¿”ã™
        exit $DOC_EXIT_CODE
    
    - name: ã‚µãƒžãƒªãƒ¼å‡ºåŠ›
      if: always()
      shell: bash
      run: |
        echo "## ðŸ¦€ Rustã‚³ãƒ¼ãƒ‰ã®lint ã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š å®Ÿè¡Œæƒ…å ±" >> $GITHUB_STEP_SUMMARY
        echo "- **Rustãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³:** ${{ inputs.toolchain }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ä½¿ç”¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ:** ${{ inputs.components }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Clippyã‚ªãƒ—ã‚·ãƒ§ãƒ³:** \`${{ inputs.clippy-options }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯:** ${{ inputs.check-documentation }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ”§ å®Ÿè¡Œã—ãŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³" >> $GITHUB_STEP_SUMMARY
        for action in $(echo $ACTION_SUMMARY | jq -r '.[]'); do
          echo "- $action" >> $GITHUB_STEP_SUMMARY
        done
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“ Lintçµæžœ" >> $GITHUB_STEP_SUMMARY
        for result in $(echo $LINT_RESULTS | jq -r '.[]'); do
          echo "- $result" >> $GITHUB_STEP_SUMMARY
        done 
name: 'Rustã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—'
description: 'Rustãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ã¨ãã®ä¾å­˜é–¢ä¿‚ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—'

inputs:
  toolchain:
    description: 'Rustã®ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³'
    required: false
    default: 'stable'
  components:
    description: 'ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ'
    required: false
    default: 'rustfmt, clippy'
  cache-key:
    description: 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚­ãƒ¼'
    required: false
    default: 'rust-setup'
  install-dependencies:
    description: 'Linuxä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‹ã©ã†ã‹'
    required: false
    default: 'false'
  just-version:
    description: 'Justã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³'
    required: false
    default: '1.23.0'

runs:
  using: "composite"
  steps:
    - name: å®Ÿè¡Œæƒ…å ±ã®åˆæœŸåŒ–
      shell: bash
      run: |
        echo "ACTION_SUMMARY=[]" >> $GITHUB_ENV
        echo "INSTALLED_TOOLS=[]" >> $GITHUB_ENV

    # justã‚’ç›´æŽ¥ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: Justã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      uses: extractions/setup-just@v3
      with:
        just-version: ${{ inputs.just-version }}
      
    - name: Justã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æƒ…å ±è¨˜éŒ²
      shell: bash
      run: |
        echo "INSTALLED_TOOLS=$(echo $INSTALLED_TOOLS | jq -c '. += ["Just (ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ inputs.just-version }})"]')" >> $GITHUB_ENV
        echo "ACTION_SUMMARY=$(echo $ACTION_SUMMARY | jq -c '. += ["Justã‚³ãƒžãƒ³ãƒ‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ãŸ"]')" >> $GITHUB_ENV

    # rustupã‚’ä½¿ç”¨
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: ${{ inputs.toolchain }}
        override: true
        components: ${{ inputs.components }}
    
    - name: Rustè¨­å®šæƒ…å ±è¨˜éŒ²
      shell: bash
      run: |
        echo "INSTALLED_TOOLS=$(echo $INSTALLED_TOOLS | jq -c '. += ["Rust (ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³: ${{ inputs.toolchain }})"]')" >> $GITHUB_ENV
        echo "ACTION_SUMMARY=$(echo $ACTION_SUMMARY | jq -c '. += ["Rustãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ (${{ inputs.toolchain }}) ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ"]')" >> $GITHUB_ENV
        echo "ACTION_SUMMARY=$(echo $ACTION_SUMMARY | jq -c '. += ["ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: ${{ inputs.components }} ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ãŸ"]')" >> $GITHUB_ENV
        
    - name: Linuxä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      if: runner.os == 'Linux' && inputs.install-dependencies == 'true'
      shell: bash
      run: |
        # sudoã‚’ä½¿ã‚ãšã«ç›´æŽ¥apt-getã‚’å®Ÿè¡Œ
        sudo apt-get update -y
        sudo apt-get install -y libx11-dev libxext-dev libxrender-dev libxtst-dev libxinerama-dev libxss-dev
        echo "ACTION_SUMMARY=$(echo $ACTION_SUMMARY | jq -c '. += ["Linuxä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ãŸ (X11ãªã©)"]')" >> $GITHUB_ENV

    # Swatinem/rust-cacheã¯ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
    # - name: Cache Rust dependencies
    #   uses: Swatinem/rust-cache@v2
    #   with:
    #     key: ${{ inputs.cache-key }} 
    
    - name: ã‚µãƒžãƒªãƒ¼å‡ºåŠ›
      shell: bash
      run: |
        echo "## ðŸ¦€ Rustã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š å®Ÿè¡Œæƒ…å ±" >> $GITHUB_STEP_SUMMARY
        echo "- **Rustãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³:** ${{ inputs.toolchain }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ:** ${{ inputs.components }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Linuxä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«:** ${{ inputs.install-dependencies }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ”§ å®Ÿè¡Œã—ãŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³" >> $GITHUB_STEP_SUMMARY
        for action in $(echo $ACTION_SUMMARY | jq -r '.[]'); do
          echo "- $action" >> $GITHUB_STEP_SUMMARY
        done
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ› ï¸ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸãƒ„ãƒ¼ãƒ«" >> $GITHUB_STEP_SUMMARY
        for tool in $(echo $INSTALLED_TOOLS | jq -r '.[]'); do
          echo "- $tool" >> $GITHUB_STEP_SUMMARY
        done 